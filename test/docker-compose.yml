version: "3.8"
services: 
    database:
        container_name: "${CONTAINER_NAME_DATABASE:-pirogue-database-instance}"
        image: mariadb:latest
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root-password}
            - MYSQL_USER=${MYSQL_USER:-website-user}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD:-website-password}
            - MYSQL_DATABASE=${MYSQL_DATABASE:-website}
        volumes:
            - ./container/database-create.sql:/docker-entrypoint-initdb.d/00-database-create.sql:ro
        ports:
            - 3306:3306
        restart: always        

    php-test:
        container_name: "${CONTAINER_NAME_UNIT_TEST:-pirogue-unit-test-instance}"
        image: "${IMAGE_NAME_UNIT_TEST:-pirogue-unit-test}"
        environment:
            - CODE_SNIFFER=${CODE_SNIFFER:-true}
        build: 
            context: ./container
            dockerfile: Containerfile-unit_testing
        volumes:
           - ./pirogue:/project/include/pirogue:rw
           - ./test:/project/testing:rw
           - ./config:/project/config:rw
           - ./view:/project/view:rw
        depends_on:
            - database
        links:
            - database        

    php-server:
        container_name: "${CONTAINER_NAME_SERVER:-pirogue-server-instance}"
        image: nginx:alpine
        volumes:
                - ./container/conf.d:/etc/nginx/conf.d:ro
                - ./www-html:/var/www/html:ro
        depends_on:
            - php-fpm
        links:
            - php-fpm
        ports:
            - 80:80
        restart: always
    
    php-fpm:
        container_name: "${CONTAINER_NAME_PHP:-pirogue-test-php-instance}"
        build: 
            context: ./container
            dockerfile: Containerfile-php        
        volumes:
            - ./www-html:/var/www/html:ro
            - ./pirogue:/var/www/include/pirogue:ro
            - ./config:/var/www/config:ro
            - ./view:/var/www/view:ro
        links:
            - database
        restart: always        
