# Docker compose file for testing.
# Three tier web server container for testing. Includes webserver, fpm and database.
version: "3.3"
services:
    site:
        image: nginx:alpine
        container_name: site
        volumes:   
            - ./etc/ssl:/etc/ssl/private:ro            
            - ./etc/nginx.conf:/etc/nginx/conf.d/default.conf:ro            
            - ./log:/var/log/nginx:rw
            - ./app/html:/var/www/html:ro
        depends_on:
            - php-fpm
        links:
            - php-fpm
        ports:
            - 80:80
            - 443:443
        restart: always

    php-fpm:
        build:
            context: ./dockerfile
            dockerfile: php-8.0
        container_name: php-fpm
        volumes:
            - ./etc/config.ini:/usr/local/etc/php/conf.d/config.ini:ro
            - ./log:/var/log/php-fpm/:rw
            - ./app/html:/var/www/html:ro
            - ./app/include/preload.inc:/var/www/include/preload.inc:ro
            - ./app/include/testing:/var/www/include/testing:ro
            - ../pirogue:/var/www/include/pirogue:ro            
            - ./app/view:/var/www/view:ro
            - ./app/config:/var/www/config:ro
        depends_on:
            - database
        links:
            - database
        restart: always

    database:
        image: mariadb:latest
        container_name: database
        env_file: ./database.env
            
        volumes:
            - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
            - ./data:/var/lib/mysql:rw
        ports:
            - 3306:3306
        restart: always
        
