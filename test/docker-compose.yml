# Docker compose file for testing.
# Three tier web server container for testing. Includes webserver, fpm and database.
version: "3.3"
services:
    site:
        image: nginx:alpine
        container_name: site
        volumes:   
            - ./etc/ssl:/etc/ssl/private:ro            
            - ./etc/nginx.conf:/etc/nginx/conf.d/default.conf:ro            
            - ./entrypoint/site:/docker-entrypoint.d:ro
            - ./log:/var/log/nginx:rw
            - ./app/www:/site/www:ro
        depends_on:
            - php-fpm
            - database
        links:
            - php-fpm
            - database
        ports:
            - 80:80
            - 443:443
        restart: always

    php-fpm:
        build:
            context: ./dockerfile
            dockerfile: php
        container_name: php-fpm
        volumes:
            - ./etc/www.conf:/usr/local/etc/php-fpm.d/www.conf:ro
            - ./etc/php-fpm.conf:/usr/local/etc/php-fpm.conf:ro
            - ./etc/config.ini:/usr/local/etc/php/conf.d/config.ini:ro
            - ./app/www:/site/www:ro
            - ./app/include:/site/include:ro
            - ./app/config:/site/config:ro
        restart: always

    database:
        image: mariadb:latest
        container_name: database
        env_file: ./database.env
            
        volumes:
            - ./entrypoint/database:/docker-entrypoint-initdb.d:ro
            - ./data:/var/lib/mysql:rw
        ports:
            - 3306:3306
        restart: always
        
